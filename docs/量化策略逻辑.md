# 量化策略逻辑文档

## 概述

本项目是一个多交易所支持的永续合约量化交易机器人，采用网格交易策略结合智能风控机制，支持多个去中心化永续合约交易所。

## 核心策略逻辑

### 1. 网格交易策略 (Grid Trading)

#### 基本机制
- **开仓逻辑**: 在市场价格附近挂限价单开仓
- **平仓逻辑**: 在开仓价格基础上按固定盈利百分比挂限价单平仓
- **网格间距**: 通过 `grid_step` 参数控制平仓单之间的最小距离

#### 开仓条件
```python
# 开仓触发条件
1. 活跃平仓单数量 < 最大订单数 (max_orders)
2. 满足等待时间条件 (wait_time)
3. 满足网格间距条件 (grid_step)
4. 未触发止损/暂停价格条件
```

#### 等待时间动态调整
根据活跃平仓单数量动态调整开仓间隔：
- 0-1/6 最大订单数: wait_time/4
- 1/6-1/3 最大订单数: wait_time/2  
- 1/3-2/3 最大订单数: wait_time
- 2/3 以上: 2 * wait_time

### 2. 智能风控系统

#### 止损机制 (Stop Loss)
- **传统止损**: 基于持仓平均价格的百分比止损
  - 做多: 当前买价 ≤ 持仓均价 × (1 - stop_loss_ratio/100)
  - 做空: 当前卖价 ≥ 持仓均价 × (1 + stop_loss_ratio/100)
- **价格止损**: 基于绝对价格的止损
  - 做多: 当前卖价 ≥ stop_price
  - 做空: 当前买价 ≤ stop_price

#### 暂停机制 (Pause Trading)
- 当价格达到暂停价格时，暂停开仓但保持现有订单
- 做多: 当前卖价 ≥ pause_price
- 做空: 当前买价 ≤ pause_price

#### 仓位监控
- 实时监控仓位与平仓单的匹配情况
- 检测到仓位不匹配时自动停止交易并发送警报

### 3. 订单管理

#### 订单生命周期
1. **开仓单**: 在中间价附近挂限价单
2. **监控执行**: 实时监控订单状态
3. **取消重挂**: 如果价格变化导致订单无法成交，自动取消并重新挂单
4. **平仓单**: 开仓成交后立即挂出平仓限价单

#### 订单状态处理
- `OPEN`: 订单已挂出
- `PARTIALLY_FILLED`: 部分成交
- `FILLED`: 完全成交
- `CANCELED`: 已取消

### 4. 网络容错机制

#### 重试策略
- **网络错误**: 指数退避重试 (0.5s, 1s, 2s)
- **Nonce错误**: 区块链确认等待 (2s, 4s, 8s)
- **其他错误**: 一般重试 (1s, 2s, 4s)

#### 连接恢复
- 检测到网络断开时自动重连
- 状态恢复：重新获取活跃订单和仓位信息

### 5. 增强模式 (Boost Mode)

#### 适用交易所
- Aster Exchange
- Backpack Exchange

#### 模式特点
- 使用市价单快速平仓
- 适用于需要快速成交的场景
- 减少滑点影响

## 策略参数详解

### 核心参数
| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `ticker` | str | ETH | 交易对 |
| `quantity` | Decimal | 0.1 | 单笔订单数量 |
| `take_profit` | Decimal | 0.02 | 盈利百分比 |
| `direction` | str | buy | 交易方向 (buy/sell) |
| `max_orders` | int | 40 | 最大活跃订单数 |
| `wait_time` | int | 450 | 基础等待时间(秒) |
| `grid_step` | Decimal | -100 | 网格间距百分比 |
| `stop_price` | Decimal | -1 | 停止价格 |
| `stop_loss_ratio` | Decimal | -1 | 止损百分比 |
| `pause_price` | Decimal | -1 | 暂停价格 |
| `boost_mode` | bool | false | 增强模式开关 |

### 动态参数
- **活跃订单数**: 实时监控的平仓单数量
- **仓位大小**: 当前持仓数量
- **平均持仓价格**: 用于止损计算

## 交易所支持

### 当前支持的交易所
- **Lighter**: ZK-Rollup 永续合约交易所
- **Aster**: 支持增强模式
- **Backpack**: 支持增强模式  
- **EdgeX**: 默认交易所
- **Apex**
- **Paradex**
- **GRVT**

### 交易所抽象层
- 统一的 API 接口设计
- 支持快速添加新交易所
- 错误处理和重试机制标准化

## 风险控制

### 多层风控
1. **价格风控**: 止损/暂停价格
2. **仓位风控**: 仓位不匹配检测
3. **订单风控**: 最大订单数限制
4. **网络风控**: 连接异常处理

### 警报机制
- 飞书 (Lark) 通知
- Telegram 通知
- 关键事件实时推送

## 性能优化

### 减少频率操作
- 止损检查: 每30秒一次
- 状态日志: 每60秒一次
- 减少不必要的API调用

### 内存管理
- 订单缓存优化
- WebSocket 连接管理
- 异常状态清理

## 使用建议

### 参数配置
1. **保守策略**: 较小的 `quantity`，较长的 `wait_time`
2. **激进策略**: 较大的 `quantity`，较短的 `wait_time`
3. **风险控制**: 合理设置 `stop_loss_ratio` 和 `stop_price`

### 监控要点
1. 定期检查日志中的仓位匹配情况
2. 关注网络连接状态
3. 监控交易所API限制

## 故障处理

### 常见问题
1. **网络断开**: 自动重连机制
2. **订单不匹配**: 自动停止并报警
3. **API限制**: 指数退避重试

### 手动干预
当检测到严重错误时：
1. 自动停止交易
2. 发送警报通知
3. 需要手动重新平衡仓位

---

*本文档基于代码分析生成，策略逻辑可能随版本更新而变化*
